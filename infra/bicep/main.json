{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "15962425669721131237"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "Environment name (dev, staging, prod)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for resources"
      }
    },
    "projectName": {
      "type": "string",
      "defaultValue": "whatssummarize",
      "minLength": 3,
      "maxLength": 15,
      "metadata": {
        "description": "Project name used for resource naming"
      }
    },
    "enableOpenAI": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Azure OpenAI deployment"
      }
    },
    "enableCosmosDB": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Cosmos DB deployment"
      }
    },
    "enableRedis": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Redis Cache deployment"
      }
    },
    "enableContainerApps": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Container Apps deployment"
      }
    },
    "enableStaticWebApps": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Static Web Apps deployment"
      }
    },
    "adminEmail": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Administrator email for alerts"
      }
    },
    "enableBudgetAlerts": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable budget alerts"
      }
    },
    "monthlyBudgetAmount": {
      "type": "int",
      "defaultValue": "[if(equals(parameters('environment'), 'prod'), 500, if(equals(parameters('environment'), 'staging'), 200, 100))]",
      "metadata": {
        "description": "Monthly budget amount in USD"
      }
    },
    "openAIDeployments": {
      "type": "array",
      "defaultValue": [
        {
          "name": "gpt-4",
          "model": "gpt-4",
          "version": "0613",
          "capacity": 10
        },
        {
          "name": "gpt-35-turbo",
          "model": "gpt-35-turbo",
          "version": "0613",
          "capacity": 30
        }
      ],
      "metadata": {
        "description": "OpenAI model deployments"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "project": "[parameters('projectName')]",
        "environment": "[parameters('environment')]",
        "managedBy": "bicep"
      },
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    }
  },
  "variables": {
    "resourcePrefix": "[format('{0}-{1}', parameters('projectName'), parameters('environment'))]",
    "resourcePrefixClean": "[replace(variables('resourcePrefix'), '-', '')]",
    "redisSku": "[if(equals(parameters('environment'), 'prod'), 'Standard', 'Basic')]",
    "redisFamily": "[if(equals(parameters('environment'), 'prod'), 'C', 'C')]",
    "redisCapacity": "[if(equals(parameters('environment'), 'prod'), 1, 0)]",
    "storageSkuName": "[if(equals(parameters('environment'), 'prod'), 'Standard_GRS', 'Standard_LRS')]",
    "containerAppCpu": "[if(equals(parameters('environment'), 'prod'), '1.0', '0.5')]",
    "containerAppMemory": "[if(equals(parameters('environment'), 'prod'), '2.0Gi', '1.0Gi')]",
    "containerAppMinReplicas": "[if(equals(parameters('environment'), 'prod'), 2, 0)]",
    "containerAppMaxReplicas": "[if(equals(parameters('environment'), 'prod'), 10, 3)]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('keyVault-{0}', parameters('environment'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('kv-{0}', variables('resourcePrefixClean'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "enableSoftDelete": {
            "value": "[equals(parameters('environment'), 'prod')]"
          },
          "enablePurgeProtection": {
            "value": "[equals(parameters('environment'), 'prod')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "16786994944328990426"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Key Vault"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "enableSoftDelete": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable soft delete"
              }
            },
            "enablePurgeProtection": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable purge protection"
              }
            },
            "softDeleteRetentionInDays": {
              "type": "int",
              "defaultValue": 7,
              "metadata": {
                "description": "Soft delete retention in days"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[subscription().tenantId]",
                "enabledForDeployment": true,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": true,
                "enableSoftDelete": "[parameters('enableSoftDelete')]",
                "enablePurgeProtection": "[if(parameters('enablePurgeProtection'), true(), null())]",
                "softDeleteRetentionInDays": "[if(parameters('enableSoftDelete'), parameters('softDeleteRetentionInDays'), null())]",
                "enableRbacAuthorization": true,
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Allow"
                }
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "uri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('name')), '2023-07-01').vaultUri]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('storage-{0}', parameters('environment'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('st{0}', variables('resourcePrefixClean'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "sku": {
            "value": "[variables('storageSkuName')]"
          },
          "containerNames": {
            "value": [
              "chat-exports",
              "user-uploads",
              "summaries"
            ]
          },
          "enableVersioning": {
            "value": "[equals(parameters('environment'), 'prod')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12825134628208587433"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "minLength": 3,
              "maxLength": 24,
              "metadata": {
                "description": "Name of the Storage Account (3-24 chars, lowercase alphanumeric)"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS",
                "Standard_ZRS",
                "Premium_LRS"
              ],
              "metadata": {
                "description": "Storage account SKU"
              }
            },
            "containerNames": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Blob container names to create"
              }
            },
            "enableVersioning": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable blob versioning"
              }
            },
            "enableBlobSoftDelete": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable soft delete for blobs"
              }
            },
            "blobSoftDeleteRetentionDays": {
              "type": "int",
              "defaultValue": 7,
              "metadata": {
                "description": "Blob soft delete retention days"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": true,
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                  "services": {
                    "blob": {
                      "enabled": true
                    },
                    "file": {
                      "enabled": true
                    }
                  },
                  "keySource": "Microsoft.Storage"
                },
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Allow"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('name'), 'default')]",
              "properties": {
                "isVersioningEnabled": "[parameters('enableVersioning')]",
                "deleteRetentionPolicy": {
                  "enabled": "[parameters('enableBlobSoftDelete')]",
                  "days": "[parameters('blobSoftDeleteRetentionDays')]"
                },
                "containerDeleteRetentionPolicy": {
                  "enabled": "[parameters('enableBlobSoftDelete')]",
                  "days": "[parameters('blobSoftDeleteRetentionDays')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
              ]
            },
            {
              "copy": {
                "name": "containers",
                "count": "[length(parameters('containerNames'))]"
              },
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('name'), 'default', parameters('containerNames')[copyIndex()])]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('name'), 'default')]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "blobEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2023-01-01').primaryEndpoints.blob]"
            },
            "primaryKey": {
              "type": "string",
              "value": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2023-01-01').keys[0].value]"
            },
            "connectionString": {
              "type": "string",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', parameters('name'), listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2023-01-01').keys[0].value, environment().suffixes.storage)]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('enableOpenAI')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('openai-{0}', parameters('environment'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('oai-{0}', variables('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "deployments": {
            "value": "[parameters('openAIDeployments')]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('keyVault-{0}', parameters('environment'))), '2025-04-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "4673547033118465472"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Azure OpenAI resource"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region (Note: Limited availability)"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "deployments": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Model deployments configuration"
              }
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Vault name for storing secrets"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "S0",
              "allowedValues": [
                "S0"
              ],
              "metadata": {
                "description": "SKU name"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2023-10-01-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "OpenAI",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "properties": {
                "customSubDomainName": "[parameters('name')]",
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "defaultAction": "Allow"
                }
              }
            },
            {
              "copy": {
                "name": "modelDeployments",
                "count": "[length(parameters('deployments'))]"
              },
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2023-10-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), parameters('deployments')[copyIndex()].name)]",
              "sku": {
                "name": "Standard",
                "capacity": "[parameters('deployments')[copyIndex()].capacity]"
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "[parameters('deployments')[copyIndex()].model]",
                  "version": "[parameters('deployments')[copyIndex()].version]"
                },
                "raiPolicyName": "Microsoft.Default"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('keyVaultName')))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'azure-openai-api-key')]",
              "properties": {
                "value": "[listKeys(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '2023-10-01-preview').key1]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('keyVaultName')))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'azure-openai-endpoint')]",
              "properties": {
                "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '2023-10-01-preview').endpoint]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('name')), '2023-10-01-preview').endpoint]"
            },
            "deploymentNames": {
              "type": "array",
              "copy": {
                "count": "[length(parameters('deployments'))]",
                "input": "[parameters('deployments')[copyIndex()].name]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('keyVault-{0}', parameters('environment')))]"
      ]
    },
    {
      "condition": "[parameters('enableCosmosDB')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('cosmosdb-{0}', parameters('environment'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('cosmos-{0}', variables('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "databaseName": {
            "value": "[parameters('projectName')]"
          },
          "containers": {
            "value": [
              {
                "name": "users",
                "partitionKey": "/id"
              },
              {
                "name": "chats",
                "partitionKey": "/userId"
              },
              {
                "name": "summaries",
                "partitionKey": "/chatId"
              }
            ]
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('keyVault-{0}', parameters('environment'))), '2025-04-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "7197341010093921498"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Cosmos DB account"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "databaseName": {
              "type": "string",
              "metadata": {
                "description": "Database name"
              }
            },
            "containers": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Container configurations"
              }
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Vault name for storing secrets"
              }
            },
            "enableFreeTier": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable free tier (only one per subscription)"
              }
            },
            "consistencyLevel": {
              "type": "string",
              "defaultValue": "Session",
              "allowedValues": [
                "Eventual",
                "ConsistentPrefix",
                "Session",
                "BoundedStaleness",
                "Strong"
              ],
              "metadata": {
                "description": "Default consistency level"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2023-11-15",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "GlobalDocumentDB",
              "properties": {
                "databaseAccountOfferType": "Standard",
                "enableFreeTier": "[parameters('enableFreeTier')]",
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "[parameters('consistencyLevel')]"
                },
                "locations": [
                  {
                    "locationName": "[parameters('location')]",
                    "failoverPriority": 0,
                    "isZoneRedundant": false
                  }
                ],
                "capabilities": [
                  {
                    "name": "EnableServerless"
                  }
                ],
                "publicNetworkAccess": "Enabled",
                "enableAutomaticFailover": false,
                "enableMultipleWriteLocations": false
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2023-11-15",
              "name": "[format('{0}/{1}', parameters('name'), parameters('databaseName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('databaseName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name'))]"
              ]
            },
            {
              "copy": {
                "name": "cosmosContainers",
                "count": "[length(parameters('containers'))]"
              },
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2023-11-15",
              "name": "[format('{0}/{1}/{2}', parameters('name'), parameters('databaseName'), parameters('containers')[copyIndex()].name)]",
              "properties": {
                "resource": {
                  "id": "[parameters('containers')[copyIndex()].name]",
                  "partitionKey": {
                    "paths": [
                      "[parameters('containers')[copyIndex()].partitionKey]"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "automatic": true,
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('name'), parameters('databaseName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('keyVaultName')))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'cosmos-db-key')]",
              "properties": {
                "value": "[listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name')), '2023-11-15').primaryMasterKey]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('keyVaultName')))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'cosmos-db-endpoint')]",
              "properties": {
                "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name')), '2023-11-15').documentEndpoint]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('keyVaultName')))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'cosmos-db-connection-string')]",
              "properties": {
                "value": "[listConnectionStrings(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name')), '2023-11-15').connectionStrings[0].connectionString]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name')), '2023-11-15').documentEndpoint]"
            },
            "databaseName": {
              "type": "string",
              "value": "[parameters('databaseName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('keyVault-{0}', parameters('environment')))]"
      ]
    },
    {
      "condition": "[parameters('enableRedis')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('redis-{0}', parameters('environment'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('redis-{0}', variables('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "sku": {
            "value": "[variables('redisSku')]"
          },
          "family": {
            "value": "[variables('redisFamily')]"
          },
          "capacity": {
            "value": "[variables('redisCapacity')]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('keyVault-{0}', parameters('environment'))), '2025-04-01').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "2168117583497835370"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Redis Cache"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Basic",
              "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
              ],
              "metadata": {
                "description": "Redis SKU"
              }
            },
            "family": {
              "type": "string",
              "defaultValue": "C",
              "allowedValues": [
                "C",
                "P"
              ],
              "metadata": {
                "description": "Redis family"
              }
            },
            "capacity": {
              "type": "int",
              "defaultValue": 0,
              "minValue": 0,
              "maxValue": 6,
              "metadata": {
                "description": "Redis capacity (0-6 for C family, 1-5 for P family)"
              }
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Vault name for storing secrets"
              }
            },
            "enableNonSslPort": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable non-SSL port (not recommended)"
              }
            },
            "minimumTlsVersion": {
              "type": "string",
              "defaultValue": "1.2",
              "allowedValues": [
                "1.0",
                "1.1",
                "1.2"
              ],
              "metadata": {
                "description": "Minimum TLS version"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Cache/redis",
              "apiVersion": "2023-08-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "[parameters('sku')]",
                  "family": "[parameters('family')]",
                  "capacity": "[parameters('capacity')]"
                },
                "enableNonSslPort": "[parameters('enableNonSslPort')]",
                "minimumTlsVersion": "[parameters('minimumTlsVersion')]",
                "publicNetworkAccess": "Enabled",
                "redisConfiguration": {
                  "maxmemory-policy": "volatile-lru"
                }
              }
            },
            {
              "condition": "[not(empty(parameters('keyVaultName')))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'redis-password')]",
              "properties": {
                "value": "[listKeys(resourceId('Microsoft.Cache/redis', parameters('name')), '2023-08-01').primaryKey]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cache/redis', parameters('name'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('keyVaultName')))]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'redis-connection-string')]",
              "properties": {
                "value": "[format('{0}:{1},password={2},ssl=True,abortConnect=False', reference(resourceId('Microsoft.Cache/redis', parameters('name')), '2023-08-01').hostName, reference(resourceId('Microsoft.Cache/redis', parameters('name')), '2023-08-01').sslPort, listKeys(resourceId('Microsoft.Cache/redis', parameters('name')), '2023-08-01').primaryKey)]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Cache/redis', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Cache/redis', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "hostname": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Cache/redis', parameters('name')), '2023-08-01').hostName]"
            },
            "port": {
              "type": "int",
              "value": "[reference(resourceId('Microsoft.Cache/redis', parameters('name')), '2023-08-01').sslPort]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('keyVault-{0}', parameters('environment')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('appinsights-{0}', parameters('environment'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('appi-{0}', variables('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "5173494274671147238"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Application Insights resource"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "applicationType": {
              "type": "string",
              "defaultValue": "web",
              "allowedValues": [
                "web",
                "other"
              ],
              "metadata": {
                "description": "Application type"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "Retention in days"
              }
            },
            "dailyCapGb": {
              "type": "int",
              "defaultValue": 0,
              "metadata": {
                "description": "Daily cap in GB (0 = no cap)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}-workspace', parameters('name'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": "[parameters('retentionInDays')]",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "[parameters('applicationType')]",
              "properties": {
                "Application_Type": "[parameters('applicationType')]",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-workspace', parameters('name')))]",
                "RetentionInDays": "[parameters('retentionInDays')]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-workspace', parameters('name')))]"
              ]
            },
            {
              "condition": "[greater(parameters('dailyCapGb'), 0)]",
              "type": "Microsoft.Insights/components/CurrentBillingFeatures",
              "apiVersion": "2015-05-01",
              "name": "[format('{0}/CurrentBillingFeatures', parameters('name'))]",
              "properties": {
                "CurrentBillingFeatures": [
                  "Basic"
                ],
                "DataVolumeCap": {
                  "Cap": "[parameters('dailyCapGb')]",
                  "ResetTime": 0,
                  "StopSendNotificationWhenHitCap": false,
                  "StopSendNotificationWhenHitThreshold": false,
                  "WarningThreshold": 90
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/components', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "instrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').InstrumentationKey]"
            },
            "connectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').ConnectionString]"
            },
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-workspace', parameters('name')))]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('enableContainerApps')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('containerapps-{0}', parameters('environment'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "environmentName": {
            "value": "[format('cae-{0}', variables('resourcePrefix'))]"
          },
          "apiAppName": {
            "value": "[format('ca-{0}-api', variables('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "appInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('appinsights-{0}', parameters('environment'))), '2025-04-01').outputs.connectionString.value]"
          },
          "keyVaultName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('keyVault-{0}', parameters('environment'))), '2025-04-01').outputs.name.value]"
          },
          "cosmosDbEndpoint": "[if(parameters('enableCosmosDB'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('cosmosdb-{0}', parameters('environment'))), '2025-04-01').outputs.endpoint.value), createObject('value', ''))]",
          "redisHostname": "[if(parameters('enableRedis'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('redis-{0}', parameters('environment'))), '2025-04-01').outputs.hostname.value), createObject('value', ''))]",
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage-{0}', parameters('environment'))), '2025-04-01').outputs.name.value]"
          },
          "openAIEndpoint": "[if(parameters('enableOpenAI'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('openai-{0}', parameters('environment'))), '2025-04-01').outputs.endpoint.value), createObject('value', ''))]",
          "apiCpu": {
            "value": "[variables('containerAppCpu')]"
          },
          "apiMemory": {
            "value": "[variables('containerAppMemory')]"
          },
          "minReplicas": {
            "value": "[variables('containerAppMinReplicas')]"
          },
          "maxReplicas": {
            "value": "[variables('containerAppMaxReplicas')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17767442577071953350"
            }
          },
          "parameters": {
            "environmentName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container Apps Environment"
              }
            },
            "apiAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the API Container App"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "keyVaultName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Vault name for secrets"
              }
            },
            "cosmosDbEndpoint": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Cosmos DB endpoint"
              }
            },
            "redisHostname": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Redis hostname"
              }
            },
            "storageAccountName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Storage account name"
              }
            },
            "openAIEndpoint": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Azure OpenAI endpoint"
              }
            },
            "apiImage": {
              "type": "string",
              "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
              "metadata": {
                "description": "Container image for API"
              }
            },
            "apiCpu": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "CPU cores for API container"
              }
            },
            "apiMemory": {
              "type": "string",
              "defaultValue": "1Gi",
              "metadata": {
                "description": "Memory for API container"
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 0,
              "metadata": {
                "description": "Minimum replicas"
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 3,
              "metadata": {
                "description": "Maximum replicas"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2023-05-01",
              "name": "[parameters('environmentName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "daprAIConnectionString": "[parameters('appInsightsConnectionString')]",
                "zoneRedundant": false,
                "workloadProfiles": [
                  {
                    "name": "Consumption",
                    "workloadProfileType": "Consumption"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2023-05-01",
              "name": "[parameters('apiAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]",
                "workloadProfileName": "Consumption",
                "configuration": {
                  "activeRevisionsMode": "Single",
                  "ingress": {
                    "external": true,
                    "targetPort": 3001,
                    "transport": "http",
                    "corsPolicy": {
                      "allowedOrigins": [
                        "*"
                      ],
                      "allowedMethods": [
                        "GET",
                        "POST",
                        "PUT",
                        "DELETE",
                        "OPTIONS"
                      ],
                      "allowedHeaders": [
                        "*"
                      ]
                    }
                  },
                  "secrets": [
                    {
                      "name": "app-insights-connection-string",
                      "value": "[parameters('appInsightsConnectionString')]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "name": "api",
                      "image": "[parameters('apiImage')]",
                      "resources": {
                        "cpu": "[json(parameters('apiCpu'))]",
                        "memory": "[parameters('apiMemory')]"
                      },
                      "env": [
                        {
                          "name": "NODE_ENV",
                          "value": "production"
                        },
                        {
                          "name": "PORT",
                          "value": "3001"
                        },
                        {
                          "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                          "secretRef": "app-insights-connection-string"
                        },
                        {
                          "name": "AZURE_COSMOS_ENDPOINT",
                          "value": "[parameters('cosmosDbEndpoint')]"
                        },
                        {
                          "name": "AZURE_REDIS_HOSTNAME",
                          "value": "[parameters('redisHostname')]"
                        },
                        {
                          "name": "AZURE_STORAGE_ACCOUNT_NAME",
                          "value": "[parameters('storageAccountName')]"
                        },
                        {
                          "name": "AZURE_OPENAI_ENDPOINT",
                          "value": "[parameters('openAIEndpoint')]"
                        },
                        {
                          "name": "AZURE_KEY_VAULT_NAME",
                          "value": "[parameters('keyVaultName')]"
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]",
                    "rules": [
                      {
                        "name": "http-rule",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "100"
                          }
                        }
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('keyVaultName')))]",
              "type": "Microsoft.KeyVault/vaults/accessPolicies",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/add', parameters('keyVaultName'))]",
              "properties": {
                "accessPolicies": [
                  {
                    "tenantId": "[subscription().tenantId]",
                    "objectId": "[reference(resourceId('Microsoft.App/containerApps', parameters('apiAppName')), '2023-05-01', 'full').identity.principalId]",
                    "permissions": {
                      "secrets": [
                        "get",
                        "list"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/containerApps', parameters('apiAppName'))]"
              ]
            }
          ],
          "outputs": {
            "environmentId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]"
            },
            "apiAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/containerApps', parameters('apiAppName'))]"
            },
            "apiUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', parameters('apiAppName')), '2023-05-01').configuration.ingress.fqdn)]"
            },
            "apiPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('apiAppName')), '2023-05-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('appinsights-{0}', parameters('environment')))]",
        "[resourceId('Microsoft.Resources/deployments', format('cosmosdb-{0}', parameters('environment')))]",
        "[resourceId('Microsoft.Resources/deployments', format('keyVault-{0}', parameters('environment')))]",
        "[resourceId('Microsoft.Resources/deployments', format('openai-{0}', parameters('environment')))]",
        "[resourceId('Microsoft.Resources/deployments', format('redis-{0}', parameters('environment')))]",
        "[resourceId('Microsoft.Resources/deployments', format('storage-{0}', parameters('environment')))]"
      ]
    },
    {
      "condition": "[parameters('enableStaticWebApps')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('staticwebapp-{0}', parameters('environment'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('stapp-{0}', variables('resourcePrefix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "apiUrl": "[if(parameters('enableContainerApps'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', format('containerapps-{0}', parameters('environment'))), '2025-04-01').outputs.apiUrl.value), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "1075212533969596653"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Static Web App"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "apiUrl": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "API backend URL"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Free",
              "allowedValues": [
                "Free",
                "Standard"
              ],
              "metadata": {
                "description": "SKU name"
              }
            },
            "repositoryUrl": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "GitHub repository URL (for linked deployment)"
              }
            },
            "branch": {
              "type": "string",
              "defaultValue": "main",
              "metadata": {
                "description": "GitHub branch"
              }
            },
            "appLocation": {
              "type": "string",
              "defaultValue": "apps/web",
              "metadata": {
                "description": "App location (path to app source)"
              }
            },
            "apiLocation": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "API location (path to API source, if using Azure Functions)"
              }
            },
            "outputLocation": {
              "type": "string",
              "defaultValue": ".next",
              "metadata": {
                "description": "Output location (build output path)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/staticSites",
              "apiVersion": "2022-09-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]",
                "tier": "[parameters('sku')]"
              },
              "properties": {
                "repositoryUrl": "[if(not(empty(parameters('repositoryUrl'))), parameters('repositoryUrl'), null())]",
                "branch": "[if(not(empty(parameters('repositoryUrl'))), parameters('branch'), null())]",
                "buildProperties": "[if(not(empty(parameters('repositoryUrl'))), createObject('appLocation', parameters('appLocation'), 'apiLocation', parameters('apiLocation'), 'outputLocation', parameters('outputLocation')), null())]",
                "stagingEnvironmentPolicy": "Enabled",
                "allowConfigFileUpdates": true,
                "enterpriseGradeCdnStatus": "Disabled"
              }
            },
            {
              "type": "Microsoft.Web/staticSites/config",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}', parameters('name'), 'appsettings')]",
              "properties": {
                "NEXT_PUBLIC_API_URL": "[parameters('apiUrl')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/staticSites', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/staticSites', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "url": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/staticSites', parameters('name')), '2022-09-01').defaultHostname)]"
            },
            "deploymentToken": {
              "type": "string",
              "value": "[listSecrets(resourceId('Microsoft.Web/staticSites', parameters('name')), '2022-09-01').properties.apiKey]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('containerapps-{0}', parameters('environment')))]"
      ]
    },
    {
      "condition": "[and(parameters('enableBudgetAlerts'), not(empty(parameters('adminEmail'))))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "[format('budget-{0}', parameters('environment'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('budget-{0}', variables('resourcePrefix'))]"
          },
          "amount": {
            "value": "[parameters('monthlyBudgetAmount')]"
          },
          "contactEmails": {
            "value": [
              "[parameters('adminEmail')]"
            ]
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9526768812736154468"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the budget"
              }
            },
            "amount": {
              "type": "int",
              "metadata": {
                "description": "Budget amount in USD"
              }
            },
            "contactEmails": {
              "type": "array",
              "metadata": {
                "description": "Email addresses to receive alerts"
              }
            },
            "resourceGroupName": {
              "type": "string",
              "defaultValue": "[resourceGroup().name]",
              "metadata": {
                "description": "Resource group name for scope"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod"
              ],
              "metadata": {
                "description": "Environment (dev, staging, prod)"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the budget"
              }
            },
            "timeGrain": {
              "type": "string",
              "defaultValue": "Monthly",
              "allowedValues": [
                "Monthly",
                "Quarterly",
                "Annually"
              ],
              "metadata": {
                "description": "Budget time grain (Monthly, Quarterly, Annually)"
              }
            },
            "currentDate": {
              "type": "string",
              "defaultValue": "[utcNow('yyyy-MM-01')]",
              "metadata": {
                "description": "Current date for budget calculation (passed from parent to ensure consistency)"
              }
            }
          },
          "variables": {
            "startDate": "[parameters('currentDate')]",
            "thresholds": "[if(equals(parameters('environment'), 'prod'), createObject('warning', 50, 'alert', 75, 'critical', 90, 'exceeded', 100), if(equals(parameters('environment'), 'staging'), createObject('warning', 60, 'alert', 80, 'critical', 95, 'exceeded', 100), createObject('warning', 70, 'alert', 85, 'critical', 100, 'exceeded', 110)))]"
          },
          "resources": [
            {
              "type": "Microsoft.Consumption/budgets",
              "apiVersion": "2023-05-01",
              "name": "[parameters('name')]",
              "properties": {
                "category": "Cost",
                "amount": "[parameters('amount')]",
                "timeGrain": "[parameters('timeGrain')]",
                "timePeriod": {
                  "startDate": "[variables('startDate')]"
                },
                "filter": {
                  "dimensions": {
                    "name": "ResourceGroupName",
                    "operator": "In",
                    "values": [
                      "[parameters('resourceGroupName')]"
                    ]
                  }
                },
                "notifications": {
                  "warningNotification": {
                    "enabled": true,
                    "operator": "GreaterThan",
                    "threshold": "[variables('thresholds').warning]",
                    "thresholdType": "Actual",
                    "contactEmails": "[parameters('contactEmails')]",
                    "contactRoles": [
                      "Owner",
                      "Contributor"
                    ],
                    "locale": "en-us"
                  },
                  "alertNotification": {
                    "enabled": true,
                    "operator": "GreaterThan",
                    "threshold": "[variables('thresholds').alert]",
                    "thresholdType": "Actual",
                    "contactEmails": "[parameters('contactEmails')]",
                    "contactRoles": [
                      "Owner",
                      "Contributor"
                    ],
                    "locale": "en-us"
                  },
                  "criticalNotification": {
                    "enabled": true,
                    "operator": "GreaterThan",
                    "threshold": "[variables('thresholds').critical]",
                    "thresholdType": "Actual",
                    "contactEmails": "[parameters('contactEmails')]",
                    "contactRoles": [
                      "Owner"
                    ],
                    "locale": "en-us"
                  },
                  "exceededNotification": {
                    "enabled": true,
                    "operator": "GreaterThan",
                    "threshold": "[variables('thresholds').exceeded]",
                    "thresholdType": "Actual",
                    "contactEmails": "[parameters('contactEmails')]",
                    "contactRoles": [
                      "Owner"
                    ],
                    "locale": "en-us"
                  },
                  "forecastedNotification": {
                    "enabled": true,
                    "operator": "GreaterThan",
                    "threshold": 100,
                    "thresholdType": "Forecasted",
                    "contactEmails": "[parameters('contactEmails')]",
                    "contactRoles": [
                      "Owner",
                      "Contributor"
                    ],
                    "locale": "en-us"
                  }
                }
              }
            }
          ],
          "outputs": {
            "budgetName": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "budgetAmount": {
              "type": "int",
              "value": "[parameters('amount')]"
            },
            "thresholds": {
              "type": "object",
              "value": "[variables('thresholds')]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('keyVault-{0}', parameters('environment'))), '2025-04-01').outputs.name.value]"
    },
    "keyVaultUri": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('keyVault-{0}', parameters('environment'))), '2025-04-01').outputs.uri.value]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage-{0}', parameters('environment'))), '2025-04-01').outputs.name.value]"
    },
    "storageBlobEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('storage-{0}', parameters('environment'))), '2025-04-01').outputs.blobEndpoint.value]"
    },
    "openAIEndpoint": {
      "type": "string",
      "value": "[if(parameters('enableOpenAI'), reference(resourceId('Microsoft.Resources/deployments', format('openai-{0}', parameters('environment'))), '2025-04-01').outputs.endpoint.value, '')]"
    },
    "openAIDeploymentNames": {
      "type": "array",
      "value": "[if(parameters('enableOpenAI'), reference(resourceId('Microsoft.Resources/deployments', format('openai-{0}', parameters('environment'))), '2025-04-01').outputs.deploymentNames.value, createArray())]"
    },
    "cosmosDBEndpoint": {
      "type": "string",
      "value": "[if(parameters('enableCosmosDB'), reference(resourceId('Microsoft.Resources/deployments', format('cosmosdb-{0}', parameters('environment'))), '2025-04-01').outputs.endpoint.value, '')]"
    },
    "cosmosDBDatabaseName": {
      "type": "string",
      "value": "[if(parameters('enableCosmosDB'), reference(resourceId('Microsoft.Resources/deployments', format('cosmosdb-{0}', parameters('environment'))), '2025-04-01').outputs.databaseName.value, '')]"
    },
    "redisHostname": {
      "type": "string",
      "value": "[if(parameters('enableRedis'), reference(resourceId('Microsoft.Resources/deployments', format('redis-{0}', parameters('environment'))), '2025-04-01').outputs.hostname.value, '')]"
    },
    "redisPort": {
      "type": "int",
      "value": "[if(parameters('enableRedis'), reference(resourceId('Microsoft.Resources/deployments', format('redis-{0}', parameters('environment'))), '2025-04-01').outputs.port.value, 0)]"
    },
    "appInsightsConnectionString": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('appinsights-{0}', parameters('environment'))), '2025-04-01').outputs.connectionString.value]"
    },
    "appInsightsInstrumentationKey": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', format('appinsights-{0}', parameters('environment'))), '2025-04-01').outputs.instrumentationKey.value]"
    },
    "containerAppsApiUrl": {
      "type": "string",
      "value": "[if(parameters('enableContainerApps'), reference(resourceId('Microsoft.Resources/deployments', format('containerapps-{0}', parameters('environment'))), '2025-04-01').outputs.apiUrl.value, '')]"
    },
    "staticWebAppUrl": {
      "type": "string",
      "value": "[if(parameters('enableStaticWebApps'), reference(resourceId('Microsoft.Resources/deployments', format('staticwebapp-{0}', parameters('environment'))), '2025-04-01').outputs.url.value, '')]"
    }
  }
}