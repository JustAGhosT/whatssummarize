name: MCP Tools

on:
  workflow_dispatch:
    inputs:
      tool:
        description: 'Tool to run'
        required: true
        type: choice
        options:
          - build
          - test
          - format
          - analyze

      parameters:
        description: 'Additional parameters (JSON)'
        required: false
        default: '{}'

jobs:
  execute-tool:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@fe1e16a35f77f2d2f7a1012a6e7ac4b5f8f8e19c # v2.4.1
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Execute Build
        if: ${{ github.event.inputs.tool == 'build' }}
        run: pnpm run build

      - name: Execute Tests
        if: ${{ github.event.inputs.tool == 'test' }}
        run: pnpm run test

      - name: Execute Format
        if: ${{ github.event.inputs.tool == 'format' }}
        run: |
          pnpm run lint
          npx prettier --check "**/*.{js,jsx,ts,tsx,json,md,mdx,yml,yaml}"

      - name: Execute Architecture Analysis
        if: ${{ github.event.inputs.tool == 'analyze' }}
        run: |
          echo "Running code quality checks..."
          pnpm run lint
          pnpm run test:coverage

      - name: Create Tool Result Comment
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const tool = '${{ github.event.inputs.tool }}';
            const status = '${{ job.status }}';
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            const comment = `## MCP Tool Execution Result

            **Tool:** ${tool}
            **Status:** ${status}
            **Run:** [View Details](${runUrl})

            Triggered via MCP Tools workflow.`;

            // If this was triggered from a PR
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }