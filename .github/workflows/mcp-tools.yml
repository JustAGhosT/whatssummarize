name: MCP Tools

on:
  workflow_dispatch:
    inputs:
      tool:
        description: 'Tool to run'
        required: true
        type: choice
        options:
          - build
          - test
          - format
          - analyze
          - deploy-staging

      parameters:
        description: 'Additional parameters (JSON)'
        required: false
        default: '{}'

jobs:
  execute-tool:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Execute Build
        if: ${{ github.event.inputs.tool == 'build' }}
        run: pnpm run build

      - name: Execute Tests
        if: ${{ github.event.inputs.tool == 'test' }}
        run: pnpm run test

      - name: Execute Format
        if: ${{ github.event.inputs.tool == 'format' }}
        run: |
          pnpm run lint
          npx prettier --check "**/*.{js,jsx,ts,tsx,json,md,mdx,yml,yaml}"

      - name: Execute Architecture Analysis
        if: ${{ github.event.inputs.tool == 'analyze' }}
        run: |
          echo "Running code quality checks..."
          pnpm run lint
          pnpm run test:coverage

      - name: Deploy to Staging
        if: ${{ github.event.inputs.tool == 'deploy-staging' }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          # Vercel deployment script
          echo "Deploying to staging..."
          npx vercel --token=$VERCEL_TOKEN

      - name: Create Tool Result Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const tool = '${{ github.event.inputs.tool }}';
            const status = '${{ job.status }}';
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            const comment = `## MCP Tool Execution Result

            **Tool:** ${tool}
            **Status:** ${status}
            **Run:** [View Details](${runUrl})

            Triggered via MCP Tools workflow.`;

            // If this was triggered from a PR
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                ...context.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }